# 1 Data decription

This document describes the structure of raster data generated by the `save_all_rasters_to_disk()` pipeline. The goal is to provide clarity on what files are produced, what they represent, and how they are organized for training or analysis workflows.

---

## 📁 Directory Layout

Each **sample** corresponds to a subfolder under the **source directory**. The script processes each sample and writes its rasterized outputs into a corresponding subfolder under the **target directory**.

```
<target_folder>/
├── sample_001/
│   ├── gicp_height.npy
│   ├── gicp_intensity.npy
│   ├── non_aligned_height.npy
│   ├── non_aligned_intensity.npy
│   ├── dsm_height.npy
│   ├── imagery.npy
│   ├── transform.pkl
│   ├── crs.pkl
│   ├── profile.pkl
│   └── resolution.pkl
├── sample_002/
│   ├── ...
└── ...
```

---

## 🗺️ Source Data Inputs

For each sample directory, the following source files are expected:

| File Name | Description |
|------------|--------------|
| `segment_gicp_utm.parquet` | LiDAR point cloud aligned using GICP (Geometric ICP). |
| `segment_utm.parquet` | LiDAR point cloud in UTM coordinates (non-aligned). |
| `segment_dsm_utm.laz` | DSM (Digital Surface Model) point data. |
| `segment_imagery_utm.tif` | Orthophoto imagery of the same region. |

If any of these files are missing, that sample is skipped.

---

## 🧩 Raster Data Keys

The script calls a function named `build_training_rasters()`, which converts the source data into a structured raster dictionary. Each raster key is either a **numpy array** or a **PyTorch tensor**.

### Tensor Arrays (.npy)

| File | Description | Shape |
|------|--------------|--------|
| `gicp_height.npy` | Height map derived from GICP-aligned LiDAR data. | (H, W) |
| `gicp_intensity.npy` | Intensity values from GICP LiDAR returns. | (H, W) |
| `non_aligned_height.npy` | Height map from non-aligned LiDAR data. | (H, W) |
| `non_aligned_intensity.npy` | Intensity map from non-aligned LiDAR. | (H, W) |
| `dsm_height.npy` | Rasterized DSM (surface elevation). | (H, W) |
| `imagery.npy` | Orthophoto imagery channels. | (C, H, W) |

All arrays are saved in **NumPy format** (`.npy`). PyTorch tensors are automatically converted before saving.

---

### Metadata (.pkl)

| File | Type | Description |
|------|------|--------------|
| `transform.pkl` | `Affine` | Spatial transform (maps raster pixels to geographic coordinates). |
| `crs.pkl` | `rasterio.crs.CRS` | Coordinate reference system (e.g., UTM zone). |
| `profile.pkl` | `dict` | Raster profile including dtype, width, height, count, etc. |
| `resolution.pkl` | `float` | Ground resolution in meters per pixel. |

All metadata objects are serialized using **Python pickle** (`.pkl`).

---

## ⚙️ Processing Parameters

The following parameters control how rasters are built (from the `build_training_rasters()` call):

| Parameter | Description | Example |
|------------|--------------|----------|
| `splat_mode` | Point rasterization method: `none`, `bilinear`, or `gaussian`. | `none` |
| `target_m_per_px` | Desired pixel size in meters. If `None`, uses native resolution. | `0.2` |
| `sampling` | Downsampling factor for quick tests (e.g., `2.0` halves resolution). | `1.0` |
| `coarsen_factor` | Integer factor for coarsening rasters. | `None` |
| `preview` | If `True`, enables visual preview of rasters during generation. | `False` |

---

## 🧠 Example Usage

```python
source_folder = "/path/to/source_samples"
target_folder = "/path/to/processed_rasters"
save_all_rasters_to_disk(source_folder, target_folder)
```

Output rasters and metadata for each sample will be saved under `target_folder`, ready for training, visualization, or GIS analysis.



---

### 🧭 Dataset Summary

**Samples scanned:** `1180 / 1180` (limit = none)

| File Name                | Unique Shapes | Status | Shape(s)     |
|---------------------------|----------------|---------|---------------|
| gicp_height.npy           | 1              | ✅      | (329, 329)    |
| gicp_intensity.npy        | 1              | ✅      | (329, 329)    |
| non_aligned_height.npy    | 1              | ✅      | (329, 329)    |
| non_aligned_intensity.npy | 1              | ✅      | (329, 329)    |
| dsm_height.npy            | 1              | ✅      | (329, 329)    |
| imagery.npy               | 1              | ✅      | (4, 329, 329) |

**Resolution:**  
Unique = 8 ⚠️  
Values = [0.304743256, 0.304743997, 0.304744315, 0.304745356, 0.304745693, 0.304746733, 0.304747088, 0.304748499]

**EPSG Codes:** `[32614]`

---

### 📊 Value Ranges (Global Across Scanned Samples)

| File Name                | Dtype     | Min        | Max        | Mean ≈      | Std ≈      |
|---------------------------|-----------|-------------|-------------|--------------|-------------|
| gicp_height.npy           | float32   | 129.07320   | 207.83093   | 149.43854    | 10.30453    |
| gicp_intensity.npy        | float32   | 0.00187     | 255.00000   | 17.64654     | 14.61820    |
| non_aligned_height.npy    | float32   | 129.20471   | 198.25021   | 148.65457    | 9.55018     |
| non_aligned_intensity.npy | float32   | 0.00251     | 255.00000   | 17.75790     | 14.66201    |
| dsm_height.npy            | float32   | 124.03886   | 295.37241   | 152.41536    | 16.46560    |
| imagery.npy               | uint8, C=4| 0.00000     | 255.00000   | 114.40533    | 57.82315    |

---

✅ **All arrays have consistent shapes.**  
⚠️ **Slight variations detected in resolution values.**  
📍 **All samples aligned to EPSG:32614.**




## ✅ Summary

This pipeline standardizes spatial data (LiDAR, DSM, imagery) into consistent raster tensors for downstream machine learning or GIS workflows. Each sample includes:
- **6 NumPy rasters** (geometric, intensity, DSM, imagery)
- **4 metadata pickle files** (spatial/georeferencing info)

Together, these provide a self-contained representation of the spatial sample with consistent spatial alignment and metadata preservation.


